<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CEA – Companies Growth</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #0b76b5;
      --primary-dark: #095f8f;
      --nav-bg: linear-gradient(90deg, #0b3c5d, #0b76b5);
      --card-bg: #ffffff;
      --shadow-soft: 0 10px 25px rgba(15, 23, 42, 0.12);
      --radius: 14px;
    }

    * { box-sizing: border-box; }

    body {
      font-family: "Poppins", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top left, #f3f4ff, #edf2f7 40%, #dde5f0 100%);
      margin: 0;
      padding: 0;
      color: #1f2933;
    }

    .nav {
      background: var(--nav-bg);
      color: #fff;
      padding: 12px 28px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.18);
      position: sticky;
      top: 0;
      z-index: 20;
    }
    .nav-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .nav-logo {
      width: 34px;
      height: 34px;
      border-radius: 8px;
      object-fit: contain;  
      background: #ffffff;  
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.18);
    }
    title {
      font-weight: 600;
      font-size: 18px;
      letter-spacing: 0.5px;
    }
    .nav-links a {
      color: #e6f4ff;
      margin-left: 18px;
      text-decoration: none;
      font-weight: 500;
      font-size: 14px;
      position: relative;
      padding-bottom: 2px;
    }
    .nav-links a::after {
      content: "";
      position: absolute;
      left: 0;
      bottom: -2px;
      width: 0;
      height: 2px;
      background: #ffeea3;
      transition: width 0.2s ease-out;
    }
    .nav-links a:hover::after { width: 100%; }

    .page {
      max-width: 1100px;
      margin: 24px auto 34px auto;
      padding: 0 18px;
    }

    .intro {
      margin-bottom: 16px;
      background: linear-gradient(135deg, #ffffffdd, #f7fafc);
      border-radius: var(--radius);
      padding: 18px 22px;
      box-shadow: 0 4px 16px rgba(15, 23, 42, 0.08);
    }
    .intro h1 {
      margin: 0 0 6px 0;
      font-size: 22px;
      color: #102a43;
    }
    .intro p {
      margin: 0;
      font-size: 13px;
      color: #52606d;
    }

    .grid {
      display: grid;
      grid-template-columns: minmax(0, 1.05fr) minmax(0, 1.4fr);
      gap: 18px;
    }
    @media (max-width: 900px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 16px 20px 18px 20px;
      box-shadow: var(--shadow-soft);
      position: relative;
      overflow: hidden;
    }
    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top right, rgba(11, 118, 181, 0.08), transparent 55%);
      opacity: 0;
      transition: opacity 0.25s ease-out;
      pointer-events: none;
    }
    .card:hover::before { opacity: 1; }

    .card-subtitle {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #829ab1;
      margin-bottom: 8px;
      font-weight: 600;
    }
    .card h2 {
      margin: 0 0 4px 0;
      font-size: 17px;
      color: #102a43;
    }

    label {
      display: block;
      margin-top: 10px;
      margin-bottom: 3px;
      font-weight: 500;
      font-size: 13px;
      color: #334e68;
    }
    input, select, button {
      width: 100%;
      margin-top: 3px;
      padding: 9px 10px;
      border-radius: 8px;
      border: 1px solid #cbd2d9;
      box-sizing: border-box;
      font-family: inherit;
      font-size: 13px;
      transition: border-color 0.15s ease-out, box-shadow 0.15s ease-out;
    }
    input:focus, select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(11,118,181,0.18);
    }
    button {
      background: var(--primary);
      color: white;
      font-weight: 600;
      cursor: pointer;
      border: none;
      margin-top: 14px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      font-size: 12px;
      box-shadow: 0 6px 16px rgba(11, 118, 181, 0.3);
    }
    button:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
    }

    #companyMsg {
      margin-top: 8px;
      font-size: 12px;
      font-weight: 600;
      color: #0b3c5d;
    }

    #companiesList {
      margin-top: 8px;
      font-size: 12px;
      color: #52606d;
    }

    #companyChart {
      border-radius: 10px;
      border: 1px solid #d8e2ec;
      background: #ffffff;
      margin-top: 10px;
    }
    #companyLabel {
      margin-top: 8px;
      font-size: 12px;
      color: #52606d;
    }
    #companyInfo {
      margin-top: 6px;
      font-size: 12px;
      color: #52606d;
    }
  </style>
</head>
<body>
  <div class="nav">
<div class="nav-left">
  <img src="Untitled design.png" alt="CEA logo" class="nav-logo">
  <div class="nav-title">CEA – Circular Economy AI</div>
</div>
    <div class="nav-links">
      <a href="/home">Home</a>
      <a href="/ai">AI</a>
      <a href="/companies">Companies</a>
      <a href="/contact">Contact Us</a>
      <a href="/login">Log In</a>
    </div>
  </div>

  <main class="page">
    <section class="intro">
      <h1>Companies & Growth with CEA</h1>
      <p>
        Add companies and simulate how their revenue could grow over 5 years
        with and without CEA. This helps show how circular‑economy strategies
        and better data can support business performance.
      </p>
    </section>

    <section class="grid">
      <div class="card">
        <div class="card-subtitle">Input</div>
        <h2>Add a Company</h2>

        <label for="cName">Company Name</label>
        <input id="cName" type="text" placeholder="Example: GreenBuild Pty Ltd">

        <label for="cSector">Sector (optional)</label>
        <input id="cSector" type="text" placeholder="Example: Construction">

        <label for="cRevenue">Current Annual Revenue (AUD)</label>
        <input id="cRevenue" type="number" min="1" step="0.01" placeholder="Example: 5000000">

        <button onclick="addCompany()">Add Company</button>

        <div id="companyMsg"></div>

        <div id="companiesList">
          No companies added yet.
        </div>
      </div>

      <div class="card">
        <div class="card-subtitle">Forecast</div>
        <h2>View Company Growth (Baseline vs With CEA)</h2>

        <label for="companySelect">Select a Company</label>
        <select id="companySelect" onchange="onCompanyChange()">
          <option value="">-- No company selected --</option>
        </select>

        <canvas id="companyChart" width="700" height="260"></canvas>
        <p id="companyLabel">
          Add a company, then select it here to see a 5‑year revenue forecast.
        </p>
        <p id="companyInfo"></p>
      </div>
    </section>
  </main>

  <script>
    let companies = [];

    async function loadCompanies() {
      try {
        const res = await fetch("/api/companies");
        const data = await res.json();
        companies = data.companies || [];
        refreshCompanySelect();
        renderCompanyList();

        if (companies.length > 0 && !document.getElementById("companySelect").value) {
          document.getElementById("companySelect").value = String(companies[0].id);
          drawSelectedCompany();
        } else {
          clearCompanyChart();
        }
      } catch (err) {
        console.error("Error loading companies:", err);
      }
    }

    async function addCompany() {
      const name = document.getElementById("cName").value.trim();
      const sector = document.getElementById("cSector").value.trim();
      const revenue = document.getElementById("cRevenue").value.trim();
      const msg = document.getElementById("companyMsg");

      msg.style.color = "#0b3c5d";
      msg.textContent = "";

      if (!name || !revenue) {
        msg.style.color = "#b00020";
        msg.textContent = "Please enter at least a company name and revenue.";
        return;
      }

      try {
        const res = await fetch("/api/companies", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({ name, sector, revenue })
        });

        const data = await res.json();
        if (!res.ok) {
          msg.style.color = "#b00020";
          msg.textContent = data.error || "Error adding company.";
          return;
        }

        msg.style.color = "#0b3c5d";
        msg.textContent = "Company added successfully.";

        document.getElementById("cName").value = "";
        document.getElementById("cSector").value = "";
        document.getElementById("cRevenue").value = "";

        companies.push(data);
        refreshCompanySelect();
        renderCompanyList();

        document.getElementById("companySelect").value = String(data.id);
        drawSelectedCompany();

      } catch (err) {
        msg.style.color = "#b00020";
        msg.textContent = "Error contacting server: " + err;
      }
    }

    function refreshCompanySelect() {
      const sel = document.getElementById("companySelect");
      const current = sel.value;
      sel.innerHTML = "";

      if (companies.length === 0) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "No company added yet";
        sel.appendChild(opt);
        return;
      }

      const opt0 = document.createElement("option");
      opt0.value = "";
      opt0.textContent = "Select a company";
      sel.appendChild(opt0);

      companies.forEach(c => {
        const opt = document.createElement("option");
        opt.value = String(c.id);
        opt.textContent = c.name + " (" + c.sector + ")";
        sel.appendChild(opt);
      });

      if (current) sel.value = current;
    }

    function renderCompanyList() {
      const box = document.getElementById("companiesList");
      if (companies.length === 0) {
        box.textContent = "No companies added yet.";
        return;
      }
      let html = "Companies added:<br>";
      html += "<ul>";
      companies.forEach(c => {
        html += `<li>${c.name} – Sector: ${c.sector}, Start revenue: LY ${c.startRevenue.toLocaleString()}</li>`;
      });
      html += "</ul>";
      box.innerHTML = html;
    }

    function onCompanyChange() {
      drawSelectedCompany();
    }

    function drawSelectedCompany() {
      const sel = document.getElementById("companySelect");
      const id = parseInt(sel.value || "0", 10);
      const company = companies.find(c => c.id === id);

      if (!company) {
        clearCompanyChart();
        return;
      }
      drawCompanyChart(company);
    }

    function clearCompanyChart() {
      const canvas = document.getElementById("companyChart");
      const ctx = canvas.getContext("2d");
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      document.getElementById("companyLabel").textContent =
        "Add a company, then select it here to see a 5‑year revenue forecast.";
      document.getElementById("companyInfo").textContent = "";
    }

    function drawCompanyChart(company) {
      const canvas = document.getElementById("companyChart");
      const ctx = canvas.getContext("2d");
      const width = canvas.width;
      const height = canvas.height;

      ctx.clearRect(0, 0, width, height);

      const years = company.years;
      const baseline = company.baseline;
      const withCEA = company.withCEA;

      const marginLeft = 60;
      const marginRight = 20;
      const marginTop = 30;
      const marginBottom = 40;

      const innerWidth = width - marginLeft - marginRight;
      const innerHeight = height - marginTop - marginBottom;

      const maxVal = Math.max(...baseline, ...withCEA) * 1.1;
      const minVal = 0;

      function yPos(value) {
        const ratio = (value - minVal) / (maxVal - minVal);
        return marginTop + innerHeight - ratio * innerHeight;
      }

      const xStep = innerWidth / (years.length - 1);

      ctx.strokeStyle = "#333";
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(marginLeft, marginTop);
      ctx.lineTo(marginLeft, marginTop + innerHeight);
      ctx.lineTo(marginLeft + innerWidth, marginTop + innerHeight);
      ctx.stroke();

      ctx.fillStyle = "#333";
      ctx.font = "12px Arial";
      const tickCount = 4;
      for (let i = 0; i <= tickCount; i++) {
        const v = minVal + (i * (maxVal - minVal) / tickCount);
        const y = yPos(v);
        ctx.fillText(Math.round(v).toLocaleString(), marginLeft - 45, y + 4);
        ctx.strokeStyle = "#eee";
        ctx.beginPath();
        ctx.moveTo(marginLeft, y);
        ctx.lineTo(marginLeft + innerWidth, y);
        ctx.stroke();
      }

      years.forEach((year, i) => {
        const x = marginLeft + i * xStep;
        const y = marginTop + innerHeight;
        ctx.fillStyle = "#333";
        ctx.fillText(year.toString(), x - 10, y + 20);
      });

      function drawLine(arr, color) {
        ctx.strokeStyle = color;
        ctx.lineWidth = 2;
        ctx.beginPath();
        arr.forEach((value, i) => {
          const x = marginLeft + i * xStep;
          const y = yPos(value);
          if (i === 0) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);
        });
        ctx.stroke();
      }

      drawLine(baseline, "#f97373");
      drawLine(withCEA, "#0b76b5");

      ctx.fillStyle = "#f97373";
      ctx.fillRect(marginLeft + 10, marginTop + 5, 12, 12);
      ctx.fillStyle = "#000";
      ctx.fillText("Baseline (no CEA)", marginLeft + 30, marginTop + 15);

      ctx.fillStyle = "#0b76b5";
      ctx.fillRect(marginLeft + 10, marginTop + 22, 12, 12);
      ctx.fillStyle = "#000";
      ctx.fillText("With CEA", marginLeft + 30, marginTop + 32);

      document.getElementById("companyLabel").textContent =
        `5‑year revenue forecast for ${company.name} (LY).`;
      document.getElementById("companyInfo").textContent =
        `Starting revenue: LY ${company.startRevenue.toLocaleString()} · Sector: ${company.sector}. ` +
        "Baseline grows at ~2%/year; With CEA grows at ~5%/year (better resource use & circular economy).";
    }

    window.onload = function () {
      loadCompanies();
    };
  </script>
</body>
</html>
